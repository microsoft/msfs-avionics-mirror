"use strict";(self.webpackChunkdocs_api=self.webpackChunkdocs_api||[]).push([[67689],{3905:(e,n,t)=>{t.d(n,{Zo:()=>d,kt:()=>h});var r=t(67294);function o(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function a(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){o(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,r,o=function(e,n){if(null==e)return{};var t,r,o={},s=Object.keys(e);for(r=0;r<s.length;r++)t=s[r],n.indexOf(t)>=0||(o[t]=e[t]);return o}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(r=0;r<s.length;r++)t=s[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}var u=r.createContext({}),l=function(e){var n=r.useContext(u),t=n;return e&&(t="function"==typeof e?e(n):a(a({},n),e)),t},d=function(e){var n=l(e.components);return r.createElement(u.Provider,{value:n},e.children)},p="mdxType",c={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var t=e.components,o=e.mdxType,s=e.originalType,u=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),p=l(t),m=o,h=p["".concat(u,".").concat(m)]||p[m]||c[m]||s;return t?r.createElement(h,a(a({ref:n},d),{},{components:t})):r.createElement(h,a({ref:n},d))}));function h(e,n){var t=arguments,o=n&&n.mdxType;if("string"==typeof e||o){var s=t.length,a=new Array(s);a[0]=m;var i={};for(var u in n)hasOwnProperty.call(n,u)&&(i[u]=n[u]);i.originalType=e,i[p]="string"==typeof e?e:o,a[1]=i;for(var l=2;l<s;l++)a[l]=t[l];return r.createElement.apply(null,a)}return r.createElement.apply(null,t)}m.displayName="MDXCreateElement"},12821:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>a,default:()=>c,frontMatter:()=>s,metadata:()=>i,toc:()=>l});var r=t(87462),o=(t(67294),t(3905));const s={sidebar_label:"SoundServer",sidebar_position:1},a="SoundServer",i={unversionedId:"sounds/soundserver",id:"sounds/soundserver",title:"SoundServer",description:"Introduction",source:"@site/docs/sounds/soundserver.md",sourceDirName:"sounds",slug:"/sounds/soundserver",permalink:"/msfs-avionics-mirror/docs/sounds/soundserver",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_label:"SoundServer",sidebar_position:1},sidebar:"sidebar",previous:{title:"Creating Plugins",permalink:"/msfs-avionics-mirror/docs/plugins/creating-plugins"},next:{title:"Aural Alert System",permalink:"/msfs-avionics-mirror/docs/sounds/aural-alert-system"}},u={},l=[{value:"Introduction",id:"introduction",level:2},{value:"Setting Up SoundServer",id:"setting-up-soundserver",level:2},{value:"Using Sound Packets",id:"using-sound-packets",level:2},{value:"Playing Simple Sounds",id:"playing-simple-sounds",level:2},{value:"Subscribing to Sound Packet Events",id:"subscribing-to-sound-packet-events",level:2},{value:"Using <code>SoundServerController</code>",id:"using-soundservercontroller",level:2}],d={toc:l},p="wrapper";function c(e){let{components:n,...t}=e;return(0,o.kt)(p,(0,r.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"soundserver"},"SoundServer"),(0,o.kt)("h2",{id:"introduction"},"Introduction"),(0,o.kt)("p",null,"The sim's native API for playing sounds from JS/HTML instruments (",(0,o.kt)("inlineCode",{parentName:"p"},"Coherent.call('PLAY_INSTRUMENT_SOUND', soundId)"),") is functional but bare. The SDK class ",(0,o.kt)("inlineCode",{parentName:"p"},"SoundServer")," provides a richer interface for playing sounds. With SoundServer, you can queue sounds, play multiple sound events in sequence, loop sounds, and be notified when sounds are finished playing."),(0,o.kt)("h2",{id:"setting-up-soundserver"},"Setting Up SoundServer"),(0,o.kt)("p",null,"SoundServer was designed to be lightweight. Using it only requires a single instance of the ",(0,o.kt)("inlineCode",{parentName:"p"},"SoundServer")," class and access to the ",(0,o.kt)("a",{parentName:"p",href:"/msfs-avionics-mirror/docs/getting-started/using-the-event-bus"},"event bus"),"."),(0,o.kt)("p",null,"The first step to using SoundServer is to create an instance of the ",(0,o.kt)("inlineCode",{parentName:"p"},"SoundServer")," class. There should be only one instance of ",(0,o.kt)("inlineCode",{parentName:"p"},"SoundServer")," across all instruments in your airplane. Once you have an instance of ",(0,o.kt)("inlineCode",{parentName:"p"},"SoundServer"),", you need to hook up its ",(0,o.kt)("inlineCode",{parentName:"p"},"onSoundEnd()")," callback method to the identically named callback in ",(0,o.kt)("inlineCode",{parentName:"p"},"BaseInstrument"),"."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { EventBus, SoundServer } from '@microsoft/msfs-sdk';\n\nclass MyInstrument extends BaseInstrument {\n\n  private readonly bus = new EventBus();\n  private readonly soundServer = new SoundServer(this.bus);\n\n  // ...\n\n  public onSoundEnd(soundEventId: Name_Z): void {\n    super.onSoundEnd(soundEventId);\n\n    this.soundServer.onSoundEnd(soundEventId);\n  }\n}\n")),(0,o.kt)("p",null,"Once the above items are completed, the final step is to ensure that all code that interacts with ",(0,o.kt)("inlineCode",{parentName:"p"},"SoundServer")," waits until the server is initialized. To know exactly when the server is initialized, you should subscribe to the ",(0,o.kt)("inlineCode",{parentName:"p"},"sound_server_initialized")," topic on the event bus:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { SoundServerEvents } from '@microsoft/msfs-sdk';\n\nbus.getSubscriber<SoundServerEvents>().on('sound_server_initialized').handle(isInit => {\n  if (isInit) {\n    // Do things...\n  }\n});\n")),(0,o.kt)("h2",{id:"using-sound-packets"},"Using Sound Packets"),(0,o.kt)("p",null,"SoundServer operates using the concept of ",(0,o.kt)("em",{parentName:"p"},"sound packets"),'. A sound packet is the fundamental "unit" of sound that can be played with SoundServer. Each sound packet has the following properties:'),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"key"),": A string that is used to reference the packet. Packets with the same key are not allowed to play at the same time. When a packet is queued, it is queued with other packets with the same key."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"sequence"),": A string or array of strings that define the sound events that are played for the packet. Each string in the sequence should be an avionics sound event ID defined in the airplane's ",(0,o.kt)("inlineCode",{parentName:"li"},"sound.xml"),". If an array of strings is used, then each sound event in the array is played in order. Sound events are also known as ",(0,o.kt)("em",{parentName:"li"},"sound atoms")," because they are the shortest bits of sound that can be played, and once a sound event starts playing it cannot be stopped until it ends."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"continuous"),": Whether the packet's sound event sequence plays in an infinite loop."),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"timeout"),': The maximum amount of time the packet\'s sound event sequence is considered to be "still playing". After the timeout duration, the system proceeds as if the sequence has finished playing, regardless of whether all the sound events in the sequence have actually finished playing. This behavior is included to prevent the system from permanently locking up if a sound event fails to play. If the packet is continuous, then the timeout is reset every time the packet loops to the beginning of its sequence. The default timeout is 10000 milliseconds.')),(0,o.kt)("p",null,"To play sound packets, use the event bus to send commands to ",(0,o.kt)("inlineCode",{parentName:"p"},"SoundServer"),". There are three different commands that will cause a packet to be played, each with slightly different behavior:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { SoundServerControlEvents } from '@microsoft/msfs-sdk';\n\n// This will play the sound packet if and only if another packet with the same key is not currently playing.\nbus.getPublisher<SoundServerControlEvents>().pub('sound_server_play', {\n  key: 'my-packet',\n  sequence: 'my_sound_event',\n  continuous: false\n}, true, false);\n\n// This will queue the sound packet to be played at the earliest opportunity. If no packet with the same key is\n// already playing or queued, then the packet will be played immediately. Otherwise, it will be queued to play after\n// all other packets with the same key that are currently playing or queued have finished playing.\nbus.getPublisher<SoundServerControlEvents>().pub('sound_server_queue', {\n  key: 'my-packet',\n  sequence: 'my_sound_event',\n  continuous: false\n}, true, false);\n\n// This will play the sound packet at the earliest opportunity. If no packet with the same key is already playing,\n// then the packet will be played immediately. Otherwise, the currently playing packet with the same key will be\n// stopped at the earliest opportunity (remember that sound atoms cannot be interrupted while they are playing), any\n// queued packets with the same key will be discarded, and the new packet will start playing once the currently playing\n// packet has been stopped.\nbus.getPublisher<SoundServerControlEvents>().pub('sound_server_interrupt', {\n  key: 'my-packet',\n  sequence: 'my_sound_event',\n  continuous: false\n}, true, false);\n")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"When publishing any of the topics defined by ",(0,o.kt)("inlineCode",{parentName:"p"},"SoundServerControlEvents"),", you ",(0,o.kt)("strong",{parentName:"p"},"must")," specify that the topic be synced to other instruments and not cached (the third and fourth parameters of ",(0,o.kt)("inlineCode",{parentName:"p"},"pub()"),", respectively). Failure to specify these options will result in incorrect behavior.")),(0,o.kt)("admonition",{type:"caution"},(0,o.kt)("p",{parentName:"admonition"},"The sim does not allow more than one instance of the same avionics sound event to be played simultaneously. Attempting to play a sound event while it is already playing simply has no effect. Therefore, it is recommended to avoid playing sound packets with different keys that also contain the same sound event at the same time. Doing so will not cause any errors, but the results will likely not match the original intention.")),(0,o.kt)("p",null,"You can also command ",(0,o.kt)("inlineCode",{parentName:"p"},"SoundServer")," to stop packets from playing once they are already playing or queued by referencing their keys:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { SoundServerControlEvents } from '@microsoft/msfs-sdk';\n\n// This will stop a continuous sound packet from looping. Has no effect on non-continuous packets that are already\n// playing. Any queued packets with the specified key will be discarded.\nbus.getPublisher<SoundServerControlEvents>().pub('sound_server_stop', 'my-packet', true, false);\n\n// This will stop an already playing packet at the earliest opportunity (remember that sound atoms cannot be\n// interrupted while they are playing). Any queued packets with the specified key will be discarded.\nbus.getPublisher<SoundServerControlEvents>().pub('sound_server_kill', 'my-packet', true, false);\n\n// Same as 'sound_server_stop', but for all packets.\nbus.getPublisher<SoundServerControlEvents>().pub('sound_server_stop_all', undefined, true, false);\n\n// Same as 'sound_server_kill', but for all packets.\nbus.getPublisher<SoundServerControlEvents>().pub('sound_server_kill_all', undefined, true, false);\n")),(0,o.kt)("h2",{id:"playing-simple-sounds"},"Playing Simple Sounds"),(0,o.kt)("p",null,"Sometimes you just need to play a simple sound event and don't need the fancy sequencing or queueing features of SoundServer. To facilitate these use cases, SoundServer supports simplified commands:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { SoundServerControlEvents } from '@microsoft/msfs-sdk';\n\nbus.getPublisher<SoundServerControlEvents>().pub('sound_server_play_sound', 'my_sound_event', true, false);\n// ... is equivalent to ...\nbus.getPublisher<SoundServerControlEvents>().pub('sound_server_play', {\n  key: 'my_sound_event',\n  sequence: 'my_sound_event',\n  continuous: false\n}, true, false);\n\n// ---------------------------------------------------------------------------------------------------------\n\nbus.getPublisher<SoundServerControlEvents>().pub('sound_server_start_sound', 'my_sound_event', true, false);\n// ... is equivalent to ...\nbus.getPublisher<SoundServerControlEvents>().pub('sound_server_play', {\n  key: 'my_sound_event',\n  sequence: 'my_sound_event',\n  continuous: true\n}, true, false);\n\n// ---------------------------------------------------------------------------------------------------------\n\nbus.getPublisher<SoundServerControlEvents>().pub('sound_server_stop_sound', 'my_sound_event', true, false);\n// ... is equivalent to ...\nbus.getPublisher<SoundServerControlEvents>().pub('sound_server_stop', 'my_sound_event', true, false);\n")),(0,o.kt)("h2",{id:"subscribing-to-sound-packet-events"},"Subscribing to Sound Packet Events"),(0,o.kt)("p",null,"If you need to know when a sound packet starts or finishes playing, you can subscribe to the following event bus topics:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { SoundServerEvents } from '@microsoft/msfs-sdk';\n\nbus.getSubscriber<SoundServerEvents>().on('sound_server_packet_started').handle(key => {\n  console.log(`A sound packet with key: ${key} has started playing.`);\n});\n\nbus.getSubscriber<SoundServerEvents>().on('sound_server_packet_ended').handle(key => {\n  console.log(`A sound packet with key: ${key} has finished playing.`);\n});\n")),(0,o.kt)("h2",{id:"using-soundservercontroller"},"Using ",(0,o.kt)("inlineCode",{parentName:"h2"},"SoundServerController")),(0,o.kt)("p",null,"For convenience, the ",(0,o.kt)("inlineCode",{parentName:"p"},"SoundServerController")," class is provided to abstract away some of the boilerplate associated with publishing commands to ",(0,o.kt)("inlineCode",{parentName:"p"},"SoundServer")," over the event bus. For each command topic in ",(0,o.kt)("inlineCode",{parentName:"p"},"SoundServerControlEvents"),", there is a corresponding method on ",(0,o.kt)("inlineCode",{parentName:"p"},"SoundServerController")," which publishes the command. The controller also facilitates waiting for ",(0,o.kt)("inlineCode",{parentName:"p"},"SoundServer")," to be initialized. For example:"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-typescript"},"import { SoundServerController } from '@microsoft/msfs-sdk';\n\nconst controller = new SoundServerController(bus);\n\n// Wait for SoundServer to be initialized...\ncontroller.awaitInitialized().then(() => {\n\n  controller.play({\n    key: 'my-packet',\n    sequence: 'my_sound_event',\n    continuous: false\n  });\n\n  controller.queue({\n    key: 'my-packet',\n    sequence: 'my_sound_event',\n    continuous: false\n  });\n\n  // ...\n\n});\n")))}c.isMDXComponent=!0}}]);